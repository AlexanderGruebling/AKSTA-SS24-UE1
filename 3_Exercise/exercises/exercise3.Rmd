```{r import_exercise3, message=FALSE, warning=FALSE, include=FALSE, echo=FALSE}

import_library <- function(library_name) {
  if (!requireNamespace(library_name, quietly = TRUE)) {
    install.packages(library_name)
  }
  library(library_name, character.only = TRUE)
}

# --------------------------

import_library("ggplot2")
import_library("readr")
import_library("dplyr")
import_library("tidyr")
import_library("tidyverse")
import_library("knitr")
import_library("plotly")
import_library("GGally")
import_library("rworldmap")

```

```{r path_determination_exercise3, include=FALSE}

# Determine if it's running as a child or not
# to fix paths when knitting
if (requireNamespace("rstudioapi", quietly = TRUE)) {
 script_path <- rstudioapi::getActiveDocumentContext()$path
 
 if (endsWith(dirname(script_path), "exercises")) {
   working_directory_path <- dirname(dirname(script_path))
 } else {
   working_directory_path <- dirname(script_path)
 }
 
} else {
 message("RStudio API is not available")
}

```

```{r prepare_data_e3, include=FALSE}

data_tibble <- read_delim(file = paste0(working_directory_path, "/data/final_data.csv"),
                          show_col_types = FALSE)

data_tibble <- data_tibble %>% 
  filter(Classification_2020 != ".")

data_tibble <- data_tibble %>% 
  mutate(Classification_2020 = factor(Classification_2020, 
                                      levels = c("L", "LM", "UM", "H"), 
                                      labels = c("Low", "Lower-middle", "Upper-middle", "High"), 
                                      ordered = TRUE)
  )

data_tibble <- data_tibble %>%
  mutate(
    Continent = factor(Continent),
    Region = factor(Region)
  )

data_tibble <- data_tibble %>%
 mutate(
    Net_Migration_Rate = na_if(Net_Migration_Rate, ".") %>% as.double(),
    Median_Age = na_if(Median_Age, ".") %>% as.double(),
    Youth_Unemployment_Rate = na_if(Youth_Unemployment_Rate, ".") %>% as.double()
  )

head(data_tibble)
```

## k. Median net migration rate per subcontinent.

Go online and find a data set which contains the 2020 population for the 
countries of the world together with ISO codes.

 - Download this data and merge it to the dataset you are working on in this 
   case study using a left join. (A possible source: [World Bank ](https://data.worldbank.org/indicator/SP.POP.TOTL?end=2020&start=2020))
 - Inspect the data and check whether the join worked well.

```{r k1, dev=c('png')}
pop_data <- read.csv("../data/country_population_data.csv")
pop_data <- pop_data[c("Country.Code", "X2020")]
colnames(pop_data) <- c("ISO", "Population_2020")
full_data <- left_join(data_tibble, pop_data)
head(full_data)
```
For the most part the join worked pretty well, I chose to use the "left_join" so that countries that are not in the original data but are in the population data will be ignored (else this would lead to rows where most of the values are N/A). Only 2 problems occured during the merge: For Kosovo, the original dataset had XKS as the ISO code, while the population set had "XKX" - this was easily corrected by changing the country code in the population data. For Taiwan, no population data was available on the "World Bank"-Site, since it is taken as a part of china $\rightarrow$ no data is available for just Taiwan alone.


## l. Scatterplot of median age and net migration rate in Europe

Make a scatterplot of median age and net migration rate for the countries of Europe. 
Scale the size of the points according to each countryâ€™s population.

 - For better visibility, use a transparency of alpha=0.7.
 - Remove the legend.
 - Comment on the plot.

```{r l1, dev=c('png')}
scatterplot_data <- full_data %>% filter(Continent=="Europe")
ggplot(scatterplot_data) + aes(x=Median_Age, y=Net_Migration_Rate, size=Population_2020, alpha=0.7, color=Country) + geom_point() + theme(legend.position = "none") + ggtitle("Median age vs. Migration Rate in Europe")
```

The median age of most European countries is above 40 years. There also doesn't seem to be any visible relation between the net migration rate and the median age, most of the datapoints are concentrated in a "blob" in the middle.

## m. Interactive plot

On the merged data set from Task k., using function ggplotly from package plotly
re-create the scatterplot in Task l., but this time for all countries. 
Color the points according to their continent.

When hovering over the points the name of the country, the values for median age, 
net migration rate, and population should be shown. 
(Hint: use the aesthetic text = Country. 
In ggplotly use the argument tooltip = c("text", "x", "y", "size")).

```{r m1, dev=c('png')}
p <- ggplot(full_data) + aes(x=Median_Age, y=Net_Migration_Rate, size=Population_2020, alpha=0.7, color=Continent, text=Country) + geom_point() + theme(legend.position = "none") + ggtitle("Median age vs. Migration Rate, Worldwide")
pltly <- ggplotly(p, tooltip=c("text", "x", "y", "size"))
pltly
```


## n. Parallel coordinate plot

In parallel coordinate plots each observation or data point is depicted as a line 
traversing a series of parallel axes, corresponding to a specific variable or dimension. 
It is often used for identifying clusters in the data.

One can create such a plot using the GGally R package. You should create such a 
plot where you look at the three main variables in the data set: median age, 
youth unemployment rate and net migration rate. 
Color the lines based on the income status. Briefly comment.

```{r n1, dev=c('png')}
library(GGally)
ggparcoord(data=full_data, columns=c(1:3), groupColumn="Classification_2020", title="Income-Class to Data Comparison, Worldwide")
```

The net migration rate and median rate seem to move up as the income-class rises for each country, while the youth unemployment-rate is more spread evenly between these classes (however most of the high-income countries still seem to have a pretty low youth unemployment rate.)

## o. World map visualisation

Using the package rworldmap, create a world map of the median age per country. 
Use the [vignette](https://cran.r-project.org/web/packages/rworldmap/vignettes/rworldmap.pdf) to find how to do this in R.

```{r o1, dev=c('png')}
library(rworldmap)
cdatamap <- joinCountryData2Map(full_data, joinCode = "ISO3", nameJoinColumn = "ISO")
par(mai=c(0,0,0.2,0),xaxs="i",yaxs="i")
mapCountryData(cdatamap, nameColumnToPlot = "Median_Age")
```
